'use strict';

var DIR_ROOT = __dirname + '/..';
var path = require('path');

var currify = require('currify/legacy');
var express = require('express');
var Router = express.Router;

var extractor = require('./extractor');

var omnesFn = currify(_omnesFn);

module.exports = function () {
    var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

    var router = Router();
    var prefix = options.prefix || '/omnes';

    router.route(prefix + '/*').get(omnesFn(options)).get(staticFn);

    return router;
};

module.exports.listen = function (socket, options) {
    if (!options) options = {};

    if (!options.prefix) options.prefix = 'omnes';

    if (!options.root) options.root = '/';

    extractor(socket, options);
};

function _omnesFn(options, req, res, next) {
    var o = options || {};
    var prefix = o.prefix || '/omnes';
    var url = req.url;

    if (url.indexOf(prefix)) return next();

    req.url = req.url.replace(prefix, '');

    if (/^\/omnes\.js(\.map)?$/.test(req.url)) req.url = '/dist' + req.url;

    next();
}

function staticFn(req, res) {
    var file = path.normalize(DIR_ROOT + req.url);
    res.sendFile(file);
}