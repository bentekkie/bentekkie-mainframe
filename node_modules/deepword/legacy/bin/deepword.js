#!/usr/bin/env node


'use strict';

var _slicedToArray2 = require('babel-runtime/helpers/slicedToArray');

var _slicedToArray3 = _interopRequireDefault(_slicedToArray2);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var fs = require('fs');
var args = process.argv.slice(2);

var _args = (0, _slicedToArray3.default)(args, 1),
    name = _args[0];

if (!name) usage();else if (/^(-v|--v)$/.test(name)) version();else if (/^(-h|--help)$/.test(name)) help();else checkFile(name, function (error) {
    if (!error) main(name);else console.error(error.message);
});

function getPath(name) {
    var reg = /^(~|\/)/;

    if (!reg.test(name)) name = process.cwd() + '/' + name;

    return name;
}

function main(name) {
    var filename = getPath(name);
    var DIR = __dirname + '/../html/';
    var deepword = require('..');
    var http = require('http');
    var express = require('express');
    var io = require('socket.io');

    var app = express();
    var server = http.createServer(app);

    var env = process.env;

    var port = env.PORT || /* c9           */
    env.app_port || /* nodester     */
    env.VCAP_APP_PORT || /* cloudfoundry */
    1337;
    var ip = env.IP || /* c9           */
    '0.0.0.0';

    app.use(express.static(DIR)).use(deepword({
        diff: true,
        zip: true
    }));

    server.listen(port, ip);

    var socket = io.listen(server);
    var edSocket = deepword.listen(socket);

    edSocket.on('connection', function () {
        fs.readFile(name, 'utf8', function (error, data) {
            if (error) console.error(error.message);else edSocket.emit('file', filename, data);
        });
    });

    console.log('url: http://' + ip + ':' + port);
}

function checkFile(name, callback) {
    fs.stat(name, function (error, stat) {
        var msg = void 0;

        if (error && error.code === 'ENOENT') msg = Error('no such file or directory: \'' + name + '\'');else if (stat.isDirectory()) msg = Error('\'' + name + '\' is directory');

        callback(msg);
    });
}

function version() {
    console.log('v' + info().version);
}

function info() {
    return require('../package');
}

function usage() {
    console.log('Usage: ' + info().name + ' [filename]');
}

function help() {
    var bin = require('../json/bin');

    usage();
    console.log('Options:');

    Object.keys(bin).forEach(function (name) {
        console.log('  ' + name + ' ' + bin[name]);
    });
}