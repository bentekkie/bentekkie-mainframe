'use strict';

var renamify = require('renamify/legacy');
var pullout = require('pullout/legacy');
var promisify = require('es6-promisify');
var pull = promisify(pullout);
var rename = function (params) {
    var dir = params.dir;
    var from = params.from;
    var to = params.to;
    
    var promise = promisify(renamify);
    return promise(dir, from, to);
}

module.exports = function (options) {
    options = options || {};
    var prefix = options.prefix || '/rename';
    
    return function (req, res, next) {
        if (req.url !== prefix)
            { return next(); }
        
        if (req.method !== 'PUT')
            { return res
                .status(404)
                .send('method should be PUT'); }
        
        var send = function () {
            res.send('rename: ok');
        };
        
        var sendError = function (ref) {
            var message = ref.message;

            return res.status(404).send(message);
        };
        
        pull(req, 'string')
            .then(JSON.parse)
            .then(rename)
            .then(send)
            .catch(sendError);
    };
};

